name: lead_convert_content
definition:
  # Wires connect to data in collections
  wires:
    lead:
      collection: uesio/crm.lead
      fields:
        uesio/crm.description:
        uesio/crm.email:
        uesio/crm.firstname:
        uesio/crm.fullname:
        uesio/crm.industry:
        uesio/crm.is_converted:
        uesio/crm.lastname:
        uesio/crm.location:
        uesio/crm.mailing_city:
        uesio/crm.mailing_country:
        uesio/crm.mailing_state_province:
        uesio/crm.mailing_street:
        uesio/crm.mailing_zip_postal:
        uesio/crm.no_employees:
        uesio/crm.title:
        uesio/crm.department:
        uesio/crm.social:
        uesio/crm.phone:
        uesio/crm.phone_business:
        uesio/crm.phone_mobile:
        uesio/crm.topic:
        uesio/crm.expected_revenue:
        uesio/crm.close_date:
        uesio/crm.image:
        uesio/crm.website:
        uesio/crm.company: {}
        uesio/core.id: {}
        uesio/core.updatedby: {}
        uesio/core.updatedat: {}
        uesio/core.createdby: {}
        uesio/core.createdat: {}
        uesio/core.owner: {}
        uesio/crm.status: {}
        uesio/crm.rating: {}
        uesio/crm.next_steps: {}
        uesio/crm.initials: {}
        uesio/crm.source: {}
      conditions:
        - field: uesio/core.id
          valueSource: PARAM
          param: recordid
    contactsearch:
      collection: uesio/crm.contact
      fields:
        uesio/crm.firstname:
        uesio/crm.lastname:
        uesio/crm.email:
        uesio/crm.phone:
        uesio/crm.initials:
        uesio/crm.account:
          fields:
            uesio/crm.name:
      conditions:
        - type: SEARCH
          id: uesio.search
          fields:
            - uesio/crm.firstname
            - uesio/crm.lastname
          value: $Param{contact}
          noValueBehavior: NOQUERY
      batchsize: 5
    accountsearch:
      collection: uesio/crm.account
      fields:
        uesio/crm.name:
        uesio/crm.initials:
        uesio/crm.description:
      conditions:
        - type: SEARCH
          id: uesio.search
          fields:
            - uesio/crm.name
          value: $Param{account}
          noValueBehavior: NOQUERY
      batchsize: 5
    opportunitysearch:
      collection: uesio/crm.opportunity
      fields:
        uesio/crm.topic:
        uesio/crm.expected_revenue:
      init:
        query: false
      batchsize: 5
    options:
      viewOnly: true
      fields:
        contact_action:
          viewOnly: true
          label: Contact Action
          type: SELECT
          selectlist:
            options:
              - value: "create"
                label: "Create new contact"
              - value: "link"
                label: "Link to existing contact"
        account_action:
          viewOnly: true
          label: Account Action
          type: SELECT
          selectlist:
            options:
              - value: "create"
                label: "Create new account"
              - value: "link"
                label: "Link to existing account"
        opportunity_action:
          viewOnly: true
          label: Opportunity Action
          type: SELECT
          selectlist:
            options:
              - value: "create"
                label: "Create new opportunity"
              - value: "link"
                label: "Link to existing opportunity"
              - value: "none"
                label: "Do not create an opportunity"
        selected_contact:
          viewOnly: true
          label: Selected Contact
          type: TEXT
        selected_contact_account:
          viewOnly: true
          label: Selected Contact Account
          type: TEXT
        selected_account:
          viewOnly: true
          label: Selected Account
          type: TEXT
        selected_opportunity:
          viewOnly: true
          label: Selected Opportunity
          type: TEXT
        selected_contact_name:
          viewOnly: true
          label: Selected Contact Name
          type: TEXT
        selected_account_name:
          viewOnly: true
          label: Selected Account Name
          type: TEXT
        selected_opportunity_name:
          viewOnly: true
          label: Selected Opportunity Name
          type: TEXT
      init:
        create: true
        query: false
      defaults:
        - field: contact_action
          valueSource: VALUE
          value: create
          conditions:
            - type: wireHasNoRecords
              wire: contactsearch
        - field: contact_action
          valueSource: VALUE
          value: link
          conditions:
            - type: wireHasRecords
              wire: contactsearch
        - field: account_action
          valueSource: VALUE
          value: create
          conditions:
            - type: wireHasNoRecords
              wire: accountsearch
        - field: account_action
          valueSource: VALUE
          value: link
          conditions:
            - type: wireHasRecords
              wire: accountsearch
        - field: opportunity_action
          valueSource: VALUE
          value: create
  # Components determine the layout and composition of your view
  components:
    - uesio/io.box:
        uesio.display:
          - type: paramIsSet
            param: recordid
        components:
          - uesio/appkit.layout_detail_split:
              main:
                - uesio/io.item:
                    wire: lead
                    uesio.id: leadList
                    mode: EDIT
                    components:
                      - uesio/io.titlebar:
                          title: ${uesio/crm.fullname}
                          subtitle: Convert Lead
                          uesio.variant: uesio/appkit.main
                          actions:
                            - uesio/io.toolbar:
                                right:
                                  - uesio/io.button:
                                      uesio.variant: uesio/appkit.primary
                                      text: Convert
                                      signals:
                                        - signal: wire/SAVE
                                          wires:
                                            - lead
                                        - signal: bot/CALL
                                          bot: uesio/crm.convert_lead
                                          stepId: convert
                                          params:
                                            lead: ${uesio/core.id}
                                            contactaction: ${options:contact_action}
                                            contact: ${options:selected_contact}
                                            accountaction: ${options:account_action}
                                            account: ${options:selected_account}
                                            opportunityaction: ${options:opportunity_action}
                                            opportunity: ${options:selected_opportunity}
                                        - signal: route/NAVIGATE_TO_ASSIGNMENT
                                          collection: uesio/crm.contact
                                          viewtype: detail
                                          recordid: $SignalOutput{[convert][contactid]}
                                  - uesio/io.button:
                                      uesio.variant: uesio/appkit.secondary
                                      text: Cancel
                                      signals:
                                        - signal: route/NAVIGATE
                                          path: "lead/detail/${uesio/core.id}"
                          avatar:
                            - uesio/io.avatar:
                                uesio.variant: uesio/appkit.main
                                text: ${initials}
                                image: $UserFile{uesio/crm.image}
                      - uesio/crm.lead_primary_section:
                      - uesio/io.box:
                          uesio.variant: uesio/appkit.section
                          components:
                            - uesio/io.titlebar:
                                title: Contact Information
                                uesio.variant: uesio/appkit.sub
                            - uesio/io.item:
                                wire: options
                                components:
                                  - uesio/io.field:
                                      uesio.context:
                                        fieldMode: EDIT
                                      labelPosition: none
                                      fieldId: contact_action
                                      displayAs: RADIO
                            - uesio/io.box:
                                uesio.display:
                                  - field: contact_action
                                    wire: options
                                    value: link
                                components:
                                  - uesio/io.searchbox:
                                      uesio.variant: uesio/appkit.main
                                      wire: contactsearch
                                      searchFields:
                                        - firstname
                                        - lastname
                                      noValueBehavior: NOQUERY
                                  - uesio/io.deck:
                                      wire: contactsearch
                                      components:
                                        - uesio/crm.contact_select_tile:
                                            uesio.display:
                                              - field: uesio/core.id
                                                value: ${options:selected_contact}
                                            selected: true
                                        - uesio/crm.contact_select_tile:
                                            uesio.display:
                                              - field: uesio/core.id
                                                operator: NOT_EQUALS
                                                value: ${options:selected_contact}
                                            selected: false
                                            signals:
                                              - signal: wire/UPDATE_RECORD
                                                wire: options
                                                field: selected_contact
                                                value: ${uesio/core.id}
                                              - signal: wire/UPDATE_RECORD
                                                wire: options
                                                field: selected_contact_name
                                                value: ${firstname} ${lastname}
                                              - signal: wire/UPDATE_RECORD
                                                wire: options
                                                field: selected_contact_account
                                                value: ${account->name}
                                              - signal: wire/SET_CONDITION
                                                wire: opportunitysearch
                                                condition:
                                                  id: account
                                                  field: uesio/crm.account
                                                  value: ${account->uesio/core.id}
                                              - signal: wire/LOAD
                                                wires:
                                                  - opportunitysearch
                                  - uesio/io.box:
                                      uesio.variant: uesio/crm.minornote
                                      uesio.display:
                                        - type: wireHasNoRecords
                                          wire: contactsearch
                                      components:
                                        - uesio/io.text:
                                            uesio.variant: uesio/io.iconoutline
                                            uesio.styleTokens:
                                              root:
                                                - text-xl
                                                - mr-3
                                            text: info
                                        - uesio/io.text:
                                            uesio.display:
                                              - type: hasValue
                                                value: $ConditionValue{contactsearch:uesio.search}
                                            text: "No results found for search: $ConditionValue{contactsearch:uesio.search}"
                                        - uesio/io.text:
                                            uesio.display:
                                              - type: hasNoValue
                                                value: $ConditionValue{contactsearch:uesio.search}
                                            text: "Search for an existing contact to link to this lead"
                            - uesio/io.box:
                                uesio.display:
                                  - field: contact_action
                                    wire: options
                                    value: create
                                components:
                                  - uesio/crm.lead_contact_info_fields:
                      - uesio/io.box:
                          uesio.variant: uesio/appkit.section
                          components:
                            - uesio/io.titlebar:
                                title: Account Information
                                uesio.variant: uesio/appkit.sub
                            - uesio/io.box:
                                uesio.display:
                                  - type: hasNoValue
                                    wire: options
                                    value: ${options:selected_contact_account}
                                components:
                                  - uesio/io.item:
                                      wire: options
                                      components:
                                        - uesio/io.field:
                                            uesio.context:
                                              fieldMode: EDIT
                                            labelPosition: none
                                            fieldId: account_action
                                            displayAs: RADIO
                                  - uesio/io.box:
                                      uesio.display:
                                        - field: account_action
                                          wire: options
                                          value: link
                                      components:
                                        - uesio/io.searchbox:
                                            uesio.variant: uesio/appkit.main
                                            wire: accountsearch
                                            searchFields:
                                              - name
                                            noValueBehavior: NOQUERY
                                        - uesio/io.deck:
                                            wire: accountsearch
                                            components:
                                              - uesio/crm.account_select_tile:
                                                  uesio.display:
                                                    - field: uesio/core.id
                                                      value: ${options:selected_account}
                                                  selected: true
                                              - uesio/crm.account_select_tile:
                                                  uesio.display:
                                                    - field: uesio/core.id
                                                      operator: NOT_EQUALS
                                                      value: ${options:selected_account}
                                                  selected: false
                                                  signals:
                                                    - signal: wire/UPDATE_RECORD
                                                      wire: options
                                                      field: selected_account
                                                      value: ${uesio/core.id}
                                                    - signal: wire/UPDATE_RECORD
                                                      wire: options
                                                      field: selected_account_name
                                                      value: ${name}
                                                    - signal: wire/SET_CONDITION
                                                      wire: opportunitysearch
                                                      condition:
                                                        id: account
                                                        field: uesio/crm.account
                                                        value: ${uesio/core.id}
                                                    - signal: wire/LOAD
                                                      wires:
                                                        - opportunitysearch
                                        - uesio/io.box:
                                            uesio.variant: uesio/crm.minornote
                                            uesio.display:
                                              - type: wireHasNoRecords
                                                wire: accountsearch
                                            components:
                                              - uesio/io.text:
                                                  uesio.variant: uesio/io.iconoutline
                                                  uesio.styleTokens:
                                                    root:
                                                      - text-xl
                                                      - mr-3
                                                  text: info
                                              - uesio/io.text:
                                                  uesio.display:
                                                    - type: hasValue
                                                      value: $ConditionValue{accountsearch:uesio.search}
                                                  text: "No results found for search: $ConditionValue{accountsearch:uesio.search}"
                                              - uesio/io.text:
                                                  uesio.display:
                                                    - type: hasNoValue
                                                      value: $ConditionValue{accountsearch:uesio.search}
                                                  text: "Search for an existing account to link to this lead"
                                  - uesio/io.box:
                                      uesio.display:
                                        - field: account_action
                                          wire: options
                                          value: create
                                      components:
                                        - uesio/crm.lead_account_info_fields:
                            - uesio/io.box:
                                uesio.display:
                                  - type: hasValue
                                    wire: options
                                    value: ${options:selected_contact_account}
                                components:
                                  - uesio/io.box:
                                      uesio.variant: uesio/crm.minornote
                                      components:
                                        - uesio/io.text:
                                            text: The linked contact's account is ${options:selected_contact_account}.
                      - uesio/io.box:
                          uesio.variant: uesio/appkit.section
                          components:
                            - uesio/io.titlebar:
                                title: Opportunity Information
                                uesio.variant: uesio/appkit.sub
                            - uesio/io.item:
                                wire: options
                                components:
                                  - uesio/io.field:
                                      uesio.context:
                                        fieldMode: EDIT
                                      labelPosition: none
                                      fieldId: opportunity_action
                                      displayAs: RADIO
                            - uesio/io.box:
                                uesio.display:
                                  - field: opportunity_action
                                    wire: options
                                    value: create
                                components:
                                  - uesio/crm.lead_opp_info_fields:
                            - uesio/io.box:
                                uesio.display:
                                  - field: opportunity_action
                                    wire: options
                                    value: link
                                components:
                                  - uesio/io.deck:
                                      wire: opportunitysearch
                                      uesio.display:
                                        - type: group
                                          conjunction: OR
                                          conditions:
                                            - field: account_action
                                              wire: options
                                              value: link
                                            - type: hasValue
                                              wire: options
                                              value: ${options:selected_contact_account}
                                      components:
                                        - uesio/crm.opportunity_select_tile:
                                            uesio.display:
                                              - field: uesio/core.id
                                                value: ${options:selected_opportunity}
                                            selected: true
                                        - uesio/crm.opportunity_select_tile:
                                            uesio.display:
                                              - field: uesio/core.id
                                                operator: NOT_EQUALS
                                                value: ${options:selected_opportunity}
                                            selected: false
                                            signals:
                                              - signal: wire/UPDATE_RECORD
                                                wire: options
                                                field: selected_opportunity
                                                value: ${uesio/core.id}
                                              - signal: wire/UPDATE_RECORD
                                                wire: options
                                                field: selected_opportunity_name
                                                value: ${topic}
                                  - uesio/io.box:
                                      uesio.variant: uesio/crm.minornote
                                      uesio.display:
                                        - type: wireHasNoRecords
                                          wire: opportunitysearch
                                        - type: group
                                          conjunction: OR
                                          conditions:
                                            - field: account_action
                                              wire: options
                                              value: link
                                            - type: hasValue
                                              wire: options
                                              value: ${options:selected_contact_account}
                                      components:
                                        - uesio/io.text:
                                            uesio.variant: uesio/io.iconoutline
                                            uesio.styleTokens:
                                              root:
                                                - text-xl
                                                - mr-3
                                            text: info
                                        - uesio/io.text:
                                            text: "No opportunities are associated with the selected account."
                                  - uesio/io.box:
                                      uesio.variant: uesio/crm.minornote
                                      uesio.display:
                                        - field: account_action
                                          operator: NOT_EQUALS
                                          wire: options
                                          value: link
                                        - type: hasNoValue
                                          wire: options
                                          value: ${options:selected_contact_account}
                                      components:
                                        - uesio/io.text:
                                            uesio.variant: uesio/io.iconoutline
                                            uesio.styleTokens:
                                              root:
                                                - text-xl
                                                - mr-3
                                            text: info
                                        - uesio/io.text:
                                            text: "You cannot link to an existing opportunity unless you're also linking to an existing account."
                      - uesio/appkit.section_audit_info:
              left:
                - uesio/io.box:
                    components:
                      - uesio/io.box:
                          uesio.variant: uesio/appkit.note
                          components:
                            - uesio/io.text:
                                text: The "Convert Lead" process lets you create an account, contact, (and optionally) an opportunity from lead. Typically, a lead should be converted when they've progressed from being a potential prospect to a qualified opportunity.
                      - uesio/io.box:
                          uesio.variant: uesio/appkit.note
                          components:
                            - uesio/io.text:
                                text: This process lets you decide whether you're creating new records for this lead or linking them to existing ones. Be sure to search for existing records to prevent creating duplicates.
                      - uesio/io.titlebar:
                          title: Pending Conversion Actions
                          uesio.variant: uesio/appkit.sub
                      - uesio/io.item:
                          wire: options
                          uesio.id: optionsItem
                          components:
                            - uesio/io.item:
                                wire: lead
                                uesio.id: pendingActions
                                components:
                                  - uesio/io.box:
                                      uesio.styleTokens:
                                        root:
                                          - "[counter-reset:items]"
                                      components:
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: mergeValue
                                                value: ${options:contact_action}
                                                sourceValue: create
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Create New Contact Record
                                                  subtitle: ${firstname} ${lastname}
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: mergeValue
                                                value: ${options:contact_action}
                                                sourceValue: link
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Contact Record
                                                  subtitle: ${options:selected_contact_name} at ${options:selected_contact_account}
                                                  uesio.display:
                                                    - type: hasValue
                                                      value: ${options:selected_contact}
                                                    - type: hasValue
                                                      value: ${options:selected_contact_account}
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Contact Record
                                                  subtitle: ${options:selected_contact_name}
                                                  uesio.display:
                                                    - type: hasValue
                                                      value: ${options:selected_contact}
                                                    - type: hasNoValue
                                                      value: ${options:selected_contact_account}
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Contact Record
                                                  subtitle: Select a contact.
                                                  uesio.display:
                                                    - type: hasNoValue
                                                      value: ${options:selected_contact}
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Migrate Timeline Activity
                                                  subtitle: Lead Activity -> Contact Activity
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: hasValue
                                                value: ${company}
                                              - type: mergeValue
                                                value: ${options:account_action}
                                                sourceValue: create
                                              - type: hasNoValue
                                                value: ${options:selected_contact_account}
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Create New Account Record
                                                  subtitle: ${company}
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: mergeValue
                                                value: ${options:account_action}
                                                sourceValue: link
                                              - type: hasNoValue
                                                value: ${options:selected_contact_account}
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Account Record
                                                  subtitle: ${options:selected_account_name}
                                                  uesio.display:
                                                    - type: hasValue
                                                      value: ${options:selected_account}
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Account Record
                                                  subtitle: Select an account.
                                                  uesio.display:
                                                    - type: hasNoValue
                                                      value: ${options:selected_account}
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: mergeValue
                                                value: ${options:opportunity_action}
                                                sourceValue: create
                                              - type: hasValue
                                                value: ${topic}
                                              - type: group
                                                conjunction: OR
                                                conditions:
                                                  - type: group
                                                    conjunction: AND
                                                    conditions:
                                                      - type: hasValue
                                                        value: ${company}
                                                      - type: mergeValue
                                                        value: ${options:account_action}
                                                        sourceValue: create
                                                  - type: group
                                                    conjunction: AND
                                                    conditions:
                                                      - type: group
                                                        conjunction: OR
                                                        conditions:
                                                          - type: hasValue
                                                            value: ${options:selected_account}
                                                          - type: hasValue
                                                            value: ${options:selected_contact_account}
                                                      - type: mergeValue
                                                        value: ${options:account_action}
                                                        sourceValue: link
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Create New Opportunity Record
                                                  subtitle: ${topic}
                                        - uesio/io.tile:
                                            uesio.variant: uesio/crm.countitem
                                            uesio.display:
                                              - type: mergeValue
                                                value: ${options:opportunity_action}
                                                sourceValue: link
                                              - type: group
                                                conjunction: OR
                                                conditions:
                                                  - type: hasValue
                                                    value: ${options:selected_account}
                                                  - type: hasValue
                                                    value: ${options:selected_contact_account}
                                            content:
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Opportunity Record
                                                  subtitle: ${options:selected_opportunity_name}
                                                  uesio.display:
                                                    - type: hasValue
                                                      value: ${options:selected_opportunity}
                                              - uesio/io.titlebar:
                                                  uesio.variant: uesio/appkit.item
                                                  title: Link to Existing Opportunity Record
                                                  subtitle: Select an opportunity.
                                                  uesio.display:
                                                    - type: hasNoValue
                                                      value: ${options:selected_opportunity}
    - uesio/io.box:
        uesio.variant: uesio/appkit.section
        uesio.display:
          - type: paramIsNotSet
            param: recordid
        components:
          - uesio/io.text:
              text: Select a record
  params:
    recordid:
      type: RECORD
      required: true
      collection: uesio/crm.lead
    contact:
      type: TEXT
    account:
      type: TEXT
